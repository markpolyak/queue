from config import *
import database
import googletable
import telebot
from telebot import types
import datetime

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª–∞—Å—Å–∞ TeleBot –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram
bot = telebot.TeleBot(TOKEN)

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª–∞—Å—Å–∞ GoogleTable –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ç–∞–±–ª–∏—Ü–∞–º
google_table = googletable.GoogleTable(FILENAME_GOOGLETABLE)
# –û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
google_table.open_table(NAME_GOOGLETABLE)


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∫–Ω–æ–ø–æ–∫) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def keyboard(user):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    buttons = [types.KeyboardButton("–°–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å"),
                types.KeyboardButton("–°–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π"),
                types.KeyboardButton("–ó–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å"),
                types.KeyboardButton("–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏"),
                types.KeyboardButton("–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π"),
                types.KeyboardButton("–ó–∞–ø–∏—Å—å –Ω–∞ –¥–æ—Å–¥–∞—á—É")]
    markup.add(*buttons)
    return markup


# –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ —Å—Ç—Ä–æ–∫–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ datetime
def convert_time(time_str):
    try:
        return datetime.datetime(year=int(time_str.split("-")[0].split(".")[2]),
                          month=int(time_str.split("-")[0].split(".")[1]),
                          day=int(time_str.split("-")[0].split(".")[0]),
                          hour=int(time_str.split("-")[1].split(":")[0]),
                          minute=int(time_str.split("-")[1].split(":")[1]))
    except IndexError:
        raise "–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì-–ß–ß:–ú–ú"


# –°–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ (user - –º–∞—Å—Å–∏–≤)
def queue_create(user):
    try:
        queue_data = user["create_queue"].split("_")  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        queue_priority = queue_data[0]  # –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏ –æ—á–µ—Ä–µ–¥–∏
        queue_subject = queue_data[1]  # –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–¥–º–µ—Ç–∞ –æ—á–µ—Ä–µ–¥–∏
        queue_teacher = queue_data[2]  # –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ –æ—á–µ—Ä–µ–¥–∏
        queue_time = queue_data[3]  # –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–µ–º–µ–Ω–∏ –æ—á–µ—Ä–µ–¥–∏
        table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
        # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π, –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—ã–ª –ª–∏ –æ–Ω –∑–∞–Ω–µ—Å—ë–Ω –≤ —Ç–∞–±–ª–∏—Ü—É
        for i in range(0, len(table_data["teacher"])):
            # –ï—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ, —Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –æ–Ω –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å
            if table_data["teacher"][i] == queue_teacher:
                # –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –≤—Ä–µ–º–µ–Ω–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ—á–µ—Ä–µ–¥–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ
                if abs((convert_time(table_data["time"][i]) - convert_time(queue_time)).seconds) <= 3600:
                    break
        else:
            # –ï—Å–ª–∏ —Ü–∏–∫–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª break, —Ç–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—á–µ—Ä–µ–¥—å
            google_table.create_queue(queue_subject, queue_teacher, queue_time, user, queue_priority)
            database.users_save(user["id"], "create_queue", "")  # –£–¥–∞–ª–µ–Ω–∏–µ –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            database.users_save(user["id"], "location_in_bot", "menu")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é –±–æ—Ç–∞
            return "–û—á–µ—Ä–µ–¥—å —Å–æ–∑–¥–∞–Ω–∞!"
        return "–£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –æ—á–µ—Ä–µ–¥—å –≤ —Ç–µ—á–µ–Ω–∏–∏ —á–∞—Å–∞ –∫ —ç—Ç–æ–º—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é!"
    except:
        return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å!"


# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—á–µ—Ä–µ–¥–µ–π
def queue_list():
    text = ""  # –¢–µ–∫—Å—Ç —Å–æ –≤—Å–µ–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏
    table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
    # –¶–∏–∫–ª, –ø—Ä–æ—Ö–æ–¥—è—â–∏–π –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã, –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
    for i in range(0, len(table_data["subject"])):
        text += f"{i+1}. " + table_data["subject"][i] + " " + table_data["teacher"][i] + " " + table_data["time"][i] + "\n" + table_data["students"][i] + "\n"
    if text == "":
        return "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—á–µ—Ä–µ–¥–µ–π –Ω–µ—Ç!"
    else:
        return "–°–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π: \n" + text


# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥—å
def queue_add(user, number):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, —á—Ç–æ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å—Ä–µ–¥–∏ –æ—á–µ—Ä–µ–¥–µ–π
        if len(table_data["subject"]) > 0 and (0 < int(number) <= len(table_data["subject"])):
            priority_id = 0  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–¥–∞–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
            # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –≤ –∑–∞–¥–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
            for name in table_data["students"][int(number)-1].split("\n"):
                # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏, —Ç–æ –µ–≥–æ –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–æ–Ω–µ—Ü –ø—Ä–∏–æ—Ä–∏—Ç–µ–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
                if name.split(" ")[0] == table_data["priority"][int(number)-1]:
                    priority_id += 1
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏, –≤ —Å–ª—É—á–∞–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –¥–∞–Ω–Ω—É—é –æ—á–µ—Ä–µ–¥—å
                if name.split(" ")[1:] == user["name"]:
                    return "–í—ã —É–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏!"
            # –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å –≤ –æ—á–µ—Ä–µ–¥–∏, —Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∞ —É –Ω–µ–≥–æ –µ—Å—Ç—å
            if user["group"] == table_data["priority"][int(number)-1]:
                students = table_data["students"][int(number) - 1].split("\n")  # –í—Å–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ –¥–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
                students.insert(priority_id, user["group"] + " " + user["name"])  # –í—Å—Ç–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏
                students = "\n".join(students)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤ —Å—Ç—Ä–æ–∫—É
                google_table.write_students(int(number) + 1, students)  # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥—å
            else: # –ù–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
                # –ó–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
                google_table.write_students(int(number)+1, table_data["students"][int(number)-1]+"\n"+user["group"]+" "+user["name"])
            return "–í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å!"
        else:
            return "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞!"
    except (IndexError, ValueError):
        return "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞!"


# –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
def queue_delete(user, number):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
        count = 1  # –°—á—ë—Ç—á–∏–∫ –ø–µ—Ä–µ–±–æ—Ä–∞ –Ω–∞—à–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –æ—á–µ—Ä–µ–¥—å
        # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ –æ—á–µ—Ä–µ–¥–∏
        for i in range(0, len(table_data["students"])):
            students = table_data["students"][i].split("\n")  # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏
            # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
            for k in range(0, len(students)):
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –Ω–µ—Ç
                if " ".join(students[k].split(" ")[1:]) == user["name"]:
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–º–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∏ –Ω–æ–º–µ—Ä, –∑–∞–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                    if count == int(number):
                        students.pop(k)  # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—á–µ—Ä–µ–¥–∏
                        update_students = "\n".join(students)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ —Å—Ç—Ä–æ–∫—É
                        # –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏ –ø—É—Å—Ç–æ–π, —Ç–æ —É–¥–∞–ª–∏—Ç—å –æ—á–µ—Ä–µ–¥—å
                        if update_students == "":
                            google_table.delete_queue(i+2)
                        else:
                            google_table.write_students(i+2, update_students)
                        return "–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–∏–ª–∏ –∑–∞–ø–∏—Å—å!"
                    count += 1

        return "–¢–∞–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Å –∑–∞–ø–∏—Å—å—é –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    except ValueError:
        return "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç–º–µ–Ω—ã!"


# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—á–µ—Ä–µ–¥–µ–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def queue_active_list(user):
    text = ""  # –¢–µ–∫—Å—Ç —Å–æ –≤—Å–µ–º–∏ –æ—á–µ—Ä–µ–¥—è–º–∏
    table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
    count = 1  # –ù–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
    # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ –æ—á–µ—Ä–µ–¥–∏
    for i in range(0, len(table_data["students"])):
        students = table_data["students"][i].split("\n")  # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏
        # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
        for k in range(0, len(students)):
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –Ω–µ—Ç
            if " ".join(students[k].split(" ")[1:]) == user["name"]:
                text += f"{count}. {k+1} –≤ –æ—á–µ—Ä–µ–¥–∏ " + table_data["subject"][i] + " " + table_data["teacher"][i] + " " + table_data["time"][i] + "\n"
                count += 1
                break
    if text == "":
        return "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–µ –≤ –æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏!"
    else:
        return "–°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π: \n" + text


# –î–æ—Å–¥–∞—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –æ—á–µ—Ä–µ–¥–∏
def queue_re_add(user, number):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        table_data = google_table.read_data()  # –ü–æ–ª—É—á–µ–Ω–∏–µ Google —Ç–∞–±–ª–∏—Ü—ã
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, —á—Ç–æ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å—Ä–µ–¥–∏ –æ—á–µ—Ä–µ–¥–µ–π
        if len(table_data["subject"]) > 0 and (0 < int(number) <= len(table_data["subject"])):
            # –¶–∏–∫–ª, –ø–µ—Ä–µ–±–∏—Ä–∞—é—â–∏–π –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥–∏
            for name in table_data["students"][int(number)-1].split("\n"):
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç–æ, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –Ω–µ—Ç
                if " ".join(name.split(" ")[1:]) == user["name"]:
                    return "–í—ã —É–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏!"
            students = table_data["students"][int(number) - 1].split("\n")  # –í—Å–µ —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ –¥–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏
            students.insert(0, user["group"] + " " + user["name"])  # –í—Å—Ç–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª–æ
            students = "\n".join(students)  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤ —Å—Ç—Ä–æ–∫—É
            google_table.write_students(int(number) + 1, students)  # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥—å
            return "–í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å!"
        else:
            return "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞!"
    except (IndexError, ValueError):
        return "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –∏–∑ —Å–ø–∏—Å–∫–∞!"


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def start_message(message):
    bot.send_message(message.chat.id, "üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –£–∫–∞–∂–∏—Ç–µ –í–∞—à—É –≥—Ä—É–ø–ø—É, —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è.\n"
                                      "–ù–∞–ø—Ä–∏–º–µ—Ä: 5810 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types='text')
def message_reply(message):
    user = database.users_read(message.chat.id)  # –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    user_message = message.text.lower()  # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–µ –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
    user_id = message.chat.id  # Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –≤ –ë–î, —Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    if user:
        user_message_split = user_message.split(" ")  # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–ª–æ–≤–∞–º
        # –ï—Å–ª–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ –≤ "create_queue_priority", —Ç–æ –∂–¥—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±—É–¥—É—â–µ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç–∏ –æ—á–µ—Ä–µ–¥–∏
        if user["location_in_bot"] == "create_queue_priority":
            if user_message == "-":
                database.users_save(user_id, "create_queue", "-_")  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ –±—É–¥—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏
                database.users_save(user_id, "location_in_bot", "create_queue_subject")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            else:
                database.users_save(user_id, "create_queue", message.text+"_")  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ –±—É–¥—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏
                database.users_save(user_id, "location_in_bot", "create_queue_subject")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞")
        # –ï—Å–ª–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ –≤ "create_queue_subject", —Ç–æ –∂–¥—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±—É–¥—É—â–µ–º –ø—Ä–µ–¥–º–µ—Ç–µ –æ—á–µ—Ä–µ–¥–∏
        elif user["location_in_bot"] == "create_queue_subject":
            database.users_save(user_id, "create_queue", user["create_queue"]+message.text+"_")  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ –±—É–¥—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏
            database.users_save(user_id, "location_in_bot", "create_queue_teacher")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è\n"
                                      "–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á")
        # –ï—Å–ª–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ –≤ "create_queue_teacher", —Ç–æ –∂–¥—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±—É–¥—É—â–µ–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ –æ—á–µ—Ä–µ–¥–∏
        elif user["location_in_bot"] == "create_queue_teacher":
            database.users_save(user_id, "create_queue", user["create_queue"] + message.text + "_")  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ –±—É–¥—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏
            database.users_save(user_id, "location_in_bot", "create_queue_time")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–æ –æ—á–µ—Ä–µ–¥–∏\n"
                                      "–ù–∞–ø—Ä–∏–º–µ—Ä: 16.07.2022 16:00")
        # –ï—Å–ª–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ –≤ "create_queue_time", —Ç–æ –∂–¥—ë–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±—É–¥—É—â–µ–º –≤—Ä–µ–º–µ–Ω–∏ –æ—á–µ—Ä–µ–¥–∏
        elif user["location_in_bot"] == "create_queue_time":
            temp_time = user_message.split(" ")  # –°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω–æ–µ –Ω–∞ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
            database.users_save(user_id, "create_queue", user["create_queue"] + temp_time[0] + "-" + temp_time[1])  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –¥–∞–Ω–Ω—ã—Ö –æ –±—É–¥—É—â–µ–π –æ—á–µ—Ä–µ–¥–∏
            database.users_save(user_id, "location_in_bot", "menu")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            bot.send_message(user_id, queue_create(database.users_read(message.chat.id))) # –°–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
        else:
            if user_message == "—Å–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å":
                bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ \"-\", –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –æ–±—ã—á–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã,"
                                          " –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å")
                database.users_save(user_id, "location_in_bot", "create_queue_priority")  # –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
            elif user_message == "—Å–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π":
                bot.send_message(user_id, queue_list())
            elif user_message == "–∑–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å":
                bot.send_message(user_id, "–î–ª—è –∑–∞–ø–∏—Å–∏ –≤ –æ—á–µ—Ä–µ–¥—å:\n–ó–∞–ø–∏—Å—å [–ù–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏]")
            elif len(user_message_split) == 2 and user_message_split[0] == "–∑–∞–ø–∏—Å—å":
                bot.send_message(user_id, queue_add(user, user_message_split[1]))
            elif user_message == "–æ—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏":
                bot.send_message(user_id, "–î–ª—è –æ—Ç–º–µ–Ω—ã –æ—á–µ—Ä–µ–¥–∏:\n–û—Ç–º–µ–Ω–∞ [–ù–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏]")
            elif len(user_message_split) == 2 and user_message_split[0] == "–æ—Ç–º–µ–Ω–∞":
                bot.send_message(user_id, queue_delete(user, user_message_split[1]))
            elif user_message == "–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π":
                bot.send_message(user_id, queue_active_list(user))
            elif user_message == "–∑–∞–ø–∏—Å—å –Ω–∞ –¥–æ—Å–¥–∞—á—É":
                bot.send_message(user_id, "–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–æ—Å–¥–∞—á—É:\n–î–æ—Å–¥–∞—Ç—å [–ù–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏]")
            elif len(user_message_split) == 2 and user_message_split[0] == "–¥–æ—Å–¥–∞—Ç—å":
                bot.send_message(user_id, queue_re_add(user, user_message_split[1]))
            else:
                bot.send_message(user_id, "–ú–µ–Ω—é\n–°–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å\n–°–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π\n–ó–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å\n"
                                          "–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏\n–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π", reply_markup=keyboard(user))
    else: # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_message_split = message.text.split(" ")  # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–ª–æ–≤–∞–º
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3 –∏ –±–æ–ª–µ–µ —Å–ª–æ–≤, —Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
        if len(user_message_split) >= 3:
            # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ë–î
            database.user_register(user_id, " ".join(user_message_split[1:]), user_message_split[0])
            bot.send_message(user_id, "–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å!")
            bot.send_message(user_id, "–ú–µ–Ω—é\n–°–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å\n–°–ø–∏—Å–æ–∫ –æ—á–µ—Ä–µ–¥–µ–π\n–ó–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥—å\n"
                                      "–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏\n–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π", reply_markup=keyboard(user))
        else:
            bot.send_message(user_id, "–£–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é –≥—Ä—É–ø–ø—É, —Ñ–∞–º–∏–ª–∏—é –∏ –∏–º—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!")


if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.")
    bot.polling(none_stop=True)  # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
